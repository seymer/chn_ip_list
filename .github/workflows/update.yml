name: Update IP Lists
on:
  schedule:
    - cron: '0 20 * * *' # UTC 20:00 (Âåó‰∫¨Êó∂Èó¥Ê¨°Êó• 04:00)
  workflow_dispatch:      # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Process IP Lists
        run: |
          set -euo pipefail
          
          # ============================================
          # ËæÖÂä©ÂáΩÊï∞
          # ============================================
          
          log_info() {
            echo "[INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1"
          }
          
          log_error() {
            echo "[ERROR] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
          }
          
          download_file() {
            local url="$1"
            local output="$2"
            local max_retries="${3:-3}"
            local retry_delay="${4:-5}"
            
            log_info "Downloading $output from $url"
            
            local retry=0
            while [ $retry -lt $max_retries ]; do
              if curl -fsSL --connect-timeout 30 --max-time 300 -o "$output" "$url"; then
                if [ -s "$output" ]; then
                  local lines=$(wc -l < "$output" 2>/dev/null || echo "0")
                  log_info "Successfully downloaded $output ($lines lines, $(wc -c < "$output") bytes)"
                  return 0
                else
                  log_error "$output is empty"
                fi
              else
                log_error "Download attempt $((retry + 1))/$max_retries failed"
              fi
              
              retry=$((retry + 1))
              if [ $retry -lt $max_retries ]; then
                log_info "Retrying in ${retry_delay}s..."
                sleep $retry_delay
              fi
            done
            
            log_error "Failed to download $output after $max_retries attempts"
            return 1
          }
          
          validate_ip_file() {
            local file="$1"
            if [ ! -f "$file" ]; then
              log_error "$file does not exist"
              return 1
            fi
            
            if [ ! -s "$file" ]; then
              log_error "$file is empty"
              return 1
            fi
            
            # È™åËØÅÊñá‰ª∂Ëá≥Â∞ëÂåÖÂê´ÊúâÊïàÁöÑ IP/CIDR Ê†ºÂºè
            # IPv4: x.x.x.x/xx Êàñ IPv6: xxxx:xxxx::/xx
            if ! grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]+$|^([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}/[0-9]+$' "$file"; then
              log_error "$file does not contain valid IP/CIDR addresses"
              return 1
            fi
            
            local count=$(wc -l < "$file")
            log_info "Validated $file: $count entries"
            return 0
          }
          
          # ============================================
          # 1. ‰∏ãËΩΩÂéüÂßãÊï∞ÊçÆ
          # ============================================
          
          log_info "Step 1: Downloading source data"
          
          # ‰∏ãËΩΩ BGP Êï∞ÊçÆÔºàÈáçËØïÊú∫Âà∂Ôºâ
          download_file "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/china.txt" "bgp-ipv4.list" 3 5
          download_file "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/china6.txt" "bgp-ipv6.list" 3 5
          
          # ‰∏ãËΩΩ APNIC Êï∞ÊçÆÔºàÂèØËÉΩÈúÄË¶ÅÊõ¥ÈïøÊó∂Èó¥Ôºâ
          download_file "https://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest" "apnic.txt" 3 10
          
          # ============================================
          # 2. Ëß£Êûê APNIC Êï∞ÊçÆ
          # ============================================
          
          log_info "Step 2: Parsing APNIC data"
          
          if ! grep -q "CN|ipv4" apnic.txt; then
            log_error "No CN IPv4 data found in APNIC file"
            exit 1
          fi
          
          cat apnic.txt | grep ipv4 | grep CN | awk -F\| '{ printf("%s/%d\n", $4, 32-log($5)/log(2)) }' > apnic-ipv4.list
          cat apnic.txt | grep "|CN|ipv6|" | cut -d"|" -f"4,5" | tr "|" "/" > apnic-ipv6.list
          
          validate_ip_file "apnic-ipv4.list"
          validate_ip_file "apnic-ipv6.list"
          
          # ============================================
          # 3. ‰∏ãËΩΩÂπ∂ËøêË°å cidr-merger (ÂéªÈáç‰∏éÂêàÂπ∂)
          # ============================================
          
          log_info "Step 3: Merging CIDR blocks"
          
          # Ëé∑Âèñ cidr-merger ‰∏ãËΩΩ URL
          CIDR_URL=$(curl -fsSL --connect-timeout 10 --max-time 30 \
            https://api.github.com/repos/zhanhb/cidr-merger/releases/latest 2>/dev/null | \
            grep -oP '"browser_download_url":\s*"\K[^"]*linux[^"]*amd64[^"]*' | head -1)
          
          if [ -z "$CIDR_URL" ]; then
            log_error "Failed to get CIDR merger download URL"
            exit 1
          fi
          
          # È™åËØÅ URL Ê†ºÂºè
          if ! echo "$CIDR_URL" | grep -qE '^https://.*github.*\.(tar\.gz|gz|zip)$|^https://.*github.*cidr-merger'; then
            log_error "Invalid CIDR merger URL format: $CIDR_URL"
            exit 1
          fi
          
          log_info "CIDR merger URL: $CIDR_URL"
          
          # ‰∏ãËΩΩ cidr-mergerÔºàÂ∏¶ÈáçËØïÔºâ
          local retry=0
          while [ $retry -lt 3 ]; do
            if wget -q --timeout=30 --tries=1 -O cidr-merger "$CIDR_URL" 2>/dev/null; then
              if [ -s cidr-merger ]; then
                chmod +x cidr-merger
                log_info "Successfully downloaded cidr-merger ($(wc -c < cidr-merger) bytes)"
                break
              else
                log_error "Downloaded cidr-merger is empty"
              fi
            else
              log_error "Download attempt $((retry + 1))/3 failed"
            fi
            
            retry=$((retry + 1))
            [ $retry -lt 3 ] && sleep 5
          done
          
          if [ ! -x cidr-merger ]; then
            log_error "Failed to download cidr-merger after 3 attempts"
            exit 1
          fi
          
          # ÂêàÂπ∂ IPv4 Âíå IPv6
          if [ -s bgp-ipv4.list ] || [ -s apnic-ipv4.list ]; then
            cat bgp-ipv4.list apnic-ipv4.list 2>/dev/null | ./cidr-merger -s > ipv4.txt
            validate_ip_file "ipv4.txt"
            log_info "IPv4 entries: $(wc -l < ipv4.txt)"
          else
            log_error "No IPv4 source data available"
            exit 1
          fi
          
          if [ -s bgp-ipv6.list ] || [ -s apnic-ipv6.list ]; then
            cat bgp-ipv6.list apnic-ipv6.list 2>/dev/null | ./cidr-merger -s > ipv6.txt
            validate_ip_file "ipv6.txt"
            log_info "IPv6 entries: $(wc -l < ipv6.txt)"
          else
            log_error "No IPv6 source data available"
            exit 1
          fi
          
          cat ipv4.txt ipv6.txt > ip.txt
          log_info "Total entries: $(wc -l < ip.txt)"
          
          # ============================================
          # 4. ÁîüÊàê Sing-box JSON (Source Ê†ºÂºè)
          # ============================================
          
          log_info "Step 4: Generating Sing-box JSON"
          
          if command -v jq &> /dev/null; then
            # ‰ΩøÁî® jq ÁîüÊàêÊ†áÂáÜ JSON
            jq -n --rawfile ips ip.txt \
              '{version: 1, rules: [{ip_cidr: ($ips | split("\n") | map(select(length > 0)))}]}' \
              > ip.json
          else
            # Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî® sed
            if [ -s ip.txt ]; then
              echo "{\"version\": 1, \"rules\": [{\"ip_cidr\": [$(sed 's/.*/"&"/' ip.txt | paste -sd, -)]}]}" > ip.json
            else
              log_error "ip.txt is empty, cannot generate JSON"
              exit 1
            fi
          fi
          
          # È™åËØÅ JSON Ê†ºÂºè
          if command -v jq &> /dev/null; then
            if ! jq empty ip.json 2>/dev/null; then
              log_error "Generated ip.json is invalid"
              exit 1
            fi
          fi
          
          log_info "Generated ip.json ($(wc -c < ip.json) bytes)"
          
          # ============================================
          # 5. ÁîüÊàê RouterOS RSC ËÑöÊú¨
          # ============================================
          
          log_info "Step 5: Generating RouterOS RSC scripts"
          
          # ÁîüÊàê‰ªÖ IPv4 ÁöÑ RSC Êñá‰ª∂
          {
            echo "# Generated at $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            echo "# IPv4-only RouterOS script for chnroute list"
            echo "# Total IPv4 entries: $(wc -l < ipv4.txt)"
            echo ""
            echo "/ip firewall address-list remove [find list=chnroute]"
            echo ""
            echo "/ip firewall address-list"
            echo "add list=chnroute address=10.0.0.0/8 comment=Private-LAN"
            echo "add list=chnroute address=172.16.0.0/12 comment=Private-LAN"
            echo "add list=chnroute address=192.168.0.0/16 comment=Private-LAN"
            echo "add list=chnroute address=127.0.0.0/8 comment=Loopback"
            
            if [ -s ipv4.txt ]; then
              awk '{print "add list=chnroute address=" $1}' ipv4.txt
            fi
          } > ipv4.rsc
          
          log_info "Generated ipv4.rsc ($(wc -l < ipv4.rsc) lines)"
          
          # ÁîüÊàêÂåÖÂê´ IPv4 Âíå IPv6 ÁöÑÂÆåÊï¥ RSC Êñá‰ª∂
          {
            echo "# Generated at $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            echo "# Full RouterOS script (IPv4 + IPv6) for chnroute list"
            echo "# Total IPv4: $(wc -l < ipv4.txt), IPv6: $(wc -l < ipv6.txt)"
            echo ""
            echo "/ip firewall address-list remove [find list=chnroute]"
            echo "/ipv6 firewall address-list remove [find list=chnroute]"
            echo ""
            echo "/ip firewall address-list"
            echo "add list=chnroute address=10.0.0.0/8 comment=Private-LAN"
            echo "add list=chnroute address=172.16.0.0/12 comment=Private-LAN"
            echo "add list=chnroute address=192.168.0.0/16 comment=Private-LAN"
            echo "add list=chnroute address=127.0.0.0/8 comment=Loopback"
            
            if [ -s ipv4.txt ]; then
              awk '{print "add list=chnroute address=" $1}' ipv4.txt
            fi
            
            echo ""
            echo "/ipv6 firewall address-list"
            echo "add list=chnroute address=::1/128 comment=Loopback"
            echo "add list=chnroute address=fe80::/10 comment=Link-Local"
            echo "add list=chnroute address=fc00::/7 comment=Unique-Local"
            
            if [ -s ipv6.txt ]; then
              awk '{print "add list=chnroute address=" $1}' ipv6.txt
            fi
          } > ip.rsc
          
          log_info "Generated ip.rsc ($(wc -l < ip.rsc) lines)"
          
          # ============================================
          # 6. ÁîüÊàêÂàÜÊµÅÂ∑•ÂÖ∑Ê†ºÂºè (Surge/Clash)
          # ============================================
          
          log_info "Step 6: Generating proxy tool configs"
          
          for i in ipv4 ipv6 ip; do
            if [ -s "$i.txt" ]; then
              # ÁîüÊàê .conf (Surge/Shadowrocket)
              sed "s|^|IP-CIDR,|g" "$i.txt" > "$i.conf"
              
              # ÁîüÊàê .yaml (Clash)
              {
                echo "# Generated at $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
                echo "payload:"
                sed "s|^|  - '|g; s|$|'|g" "$i.txt"
              } > "$i.yaml"
              
              log_info "Generated $i.conf and $i.yaml"
            fi
          done
          
          # ============================================
          # 7. ÁîüÊàê MMDB Êï∞ÊçÆÂ∫ì
          # ============================================
          
          log_info "Step 7: Generating MMDB databases"
          
          MMDB_URL=$(curl -fsSL https://api.github.com/repos/carrnot/mmdb-go/releases/latest | \
            grep -oP '"browser_download_url":\s*"\K[^"]*linux64\.tar\.gz[^"]*' | head -1)
          
          if [ -n "$MMDB_URL" ]; then
            log_info "MMDB URL: $MMDB_URL"
            
            if wget -q --timeout=30 -O mmdb-go.tar.gz "$MMDB_URL"; then
              tar -xzf mmdb-go.tar.gz
              
              # Êü•ÊâæÂèØÊâßË°åÊñá‰ª∂ÔºàÊõ¥Á≤æÁ°ÆÁöÑÂåπÈÖçÔºâ
              MMDB_BIN=$(find . -maxdepth 1 -type f -executable \( -name "mmdb-go*" -o -name "*mmdb*" \) ! -name "*.tar.gz" ! -name "*.mmdb" | head -1)
              
              if [ -n "$MMDB_BIN" ] && [ -x "$MMDB_BIN" ]; then
                log_info "Found MMDB binary: $MMDB_BIN"
                
                [ -s ipv4.txt ] && "$MMDB_BIN" -i ipv4.txt -o ipv4.mmdb && log_info "Generated ipv4.mmdb"
                [ -s ipv6.txt ] && "$MMDB_BIN" -i ipv6.txt -o ipv6.mmdb && log_info "Generated ipv6.mmdb"
                [ -s ip.txt ] && "$MMDB_BIN" -i ip.txt -o ip.mmdb && log_info "Generated ip.mmdb"
                
                rm -f "$MMDB_BIN"
              else
                log_error "MMDB binary not found or not executable"
              fi
              
              rm -f mmdb-go.tar.gz
            else
              log_error "Failed to download MMDB tool, skipping MMDB generation"
            fi
          else
            log_error "Failed to get MMDB download URL, skipping MMDB generation"
          fi
          
          # ============================================
          # 8. Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
          # ============================================
          
          log_info "Step 8: Cleaning up temporary files"
          
          rm -f bgp-ipv4.list bgp-ipv6.list apnic-ipv4.list apnic-ipv6.list
          rm -f cidr-merger apnic.txt mmdb-go.tar.gz
          
          # Ê∏ÖÁêÜÂèØËÉΩÁöÑËß£ÂéãÊÆãÁïô
          find . -maxdepth 1 -type f \( -name "mmdb-go*" -o -name "*mmdb*" \) ! -name "*.mmdb" -delete 2>/dev/null || true
          
          # ============================================
          # 9. ÁîüÊàêÊëòË¶Å‰ø°ÊÅØ
          # ============================================
          
          log_info "Step 9: Generating summary"
          
          {
            echo "# IP Lists Update Summary"
            echo ""
            echo "**Generated at:** $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            echo ""
            echo "## Statistics"
            echo ""
            echo "| Type | Count | Size |"
            echo "|------|-------|------|"
            [ -f ipv4.txt ] && echo "| IPv4 | $(wc -l < ipv4.txt) | $(wc -c < ipv4.txt) bytes |"
            [ -f ipv6.txt ] && echo "| IPv6 | $(wc -l < ipv6.txt) | $(wc -c < ipv6.txt) bytes |"
            [ -f ip.txt ] && echo "| Total | $(wc -l < ip.txt) | $(wc -c < ip.txt) bytes |"
            echo ""
            echo "## Generated Files"
            echo ""
            for ext in txt json rsc conf yaml mmdb; do
              for file in *.$ext; do
                if [ -f "$file" ]; then
                  echo "- \`$file\` ($(wc -l < "$file" 2>/dev/null || echo 0) lines, $(wc -c < "$file" | awk '{printf "%.1f", $1/1024}') KB)"
                fi
              done
            done
          } > SUMMARY.md
          
          cat SUMMARY.md
          
          log_info "All steps completed successfully!"
          log_info "Generated files: $(ls -1 *.txt *.json *.rsc *.conf *.yaml *.mmdb 2>/dev/null | wc -l) files"

      - name: Push to GitHub
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Update IP lists: $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git push
            echo "Changes pushed successfully"
          fi